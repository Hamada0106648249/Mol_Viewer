<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unified MD Trajectory Viewer — Smoothing + VR — Dr. Ahmed Sayed</title>
  <!-- Left: NGL for robust local uploads + true trajectory mode with interpolation -->
  <script src="https://unpkg.com/ngl@latest/dist/ngl.js"></script>
  <!-- Right: Mol* for WebXR/VR and RCSB-native look (pinned version) -->
  <link rel="stylesheet" href="https://unpkg.com/molstar@3.49.0/build/viewer/molstar.css" />
  <script src="https://unpkg.com/molstar@3.49.0/build/viewer/molstar.js" defer></script>
  <style>
    :root { --bg:#0b1021; --panel:#12172b; --ink:#e8ebff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto 1fr;gap:10px;height:100%}
    .hdr{grid-column:1/3;background:var(--panel);padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hdr input,.hdr select,.hdr button{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);color:var(--ink);border-radius:8px;padding:6px 10px}
    .hdr button{cursor:pointer}
    .col{position:relative}
    #ngl,#molstar{position:absolute;inset:0}
    .ttl{font-weight:700}
    .note{font-size:12px;opacity:.9}
    .panel{position:absolute;left:10px;top:10px;z-index:5;background:rgba(0,0,0,.5);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15)}
    .log{position:absolute;right:10px;top:10px;z-index:6;width:420px;max-height:48vh;overflow:auto;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);font:12px/1.35 ui-monospace,monospace}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label.small{font-size:12px}
  </style>
</head>
<body>
  <div class="grid">
    <div class="hdr">
      <span class="ttl">Unified MD Trajectory Viewer — <b>NGL Smoothing</b> + <b>Mol* VR</b> — Dr. Ahmed Sayed</span>

      <button id="btn-open" type="button">Open File…</button>
      <label for="file" style="text-decoration:underline;cursor:pointer">Choose File</label>
      <input id="file" type="file" accept=".pdb,.cif,.mmcif,.mmtf,.gro,.xtc,.dcd,.trr,.ent" style="display:none" />

      <span>|</span>
      <label>URL <input id="url" type="url" size="40" placeholder="https://…/traj.pdb (CORS required)"></label>
      <button id="btn-load-url" type="button">Load URL</button>

      <span>|</span>
      <label>PDB ID <input id="pdb" size="6" placeholder="1CRN"></label>
      <button id="btn-load-pdb" type="button">Fetch</button>

      <span class="note">Left (NGL): plays local/URL trajectories with true trajectory mode + interpolation. Right (Mol*): VR (WebXR) + timeline for multi-model inputs.</span>
    </div>

    <div class="col" id="col-ngl">
      <div id="ngl"></div>
      <div class="panel">
        <div class="row"><b>NGL — Trajectory & Smoothing</b></div>
        <div class="row">
          <label class="small">Interp
            <select id="interp">
              <option value="none">none</option>
              <option value="linear">linear</option>
              <option value="spline" selected>spline</option>
            </select>
          </label>
          <label class="small">Speed <input type="range" id="speed" min="0" max="100" value="60"></label>
          <label class="small">Frame <input type="range" id="frame" min="0" max="0" value="0"></label>
          <span id="frameInfo" class="small">0 / 0</span>
          <button id="btn-play" type="button">Play</button>
          <button id="btn-pause" type="button">Pause</button>
          <button id="btn-repr" type="button">Cartoon</button>
        </div>
      </div>
    </div>

    <div class="col" id="col-molstar">
      <div id="molstar"></div>
      <div class="panel"><b>Mol* — VR (WebXR)</b>
        <div class="note">Use the VR headset icon in Mol* controls when available. For local files, VR works best when the file is hosted via HTTPS with CORS (e.g., same GitHub Pages repo).</div>
      </div>
    </div>
  </div>

  <div class="log" id="log"></div>

<script>
(function(){
  const log = document.getElementById('log');
  const L = (...a)=>{const s=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); log.innerHTML = '<div>'+s+'</div>'+log.innerHTML; console.log(...a);};

  // --- NGL VIEWER (left) ---
  const stage = new NGL.Stage('ngl', {backgroundColor:'#0b1021'});
  window.addEventListener('resize', ()=>{stage.handleResize();});
  let nglComp = null; // component
  let nglTraj = null; // trajectory if available

  // Decide if we should force asTrajectory
  function shouldAsTrajectory(name){
    const ext = (name||'').split('.').pop().toLowerCase();
    return ['pdb','ent','cif','mmcif','mmtf','gro'].includes(ext);
  }

  async function nglLoad(source, opts){
    try{
      if (nglComp) { stage.removeComponent(nglComp); nglComp = null; nglTraj = null; }
      const isFile = (source instanceof File) || (source instanceof Blob);
      const name = isFile ? source.name : (typeof source === 'string' ? source : '');
      const primaryOpts = Object.assign({}, opts||{});
      if (shouldAsTrajectory(name) || typeof source === 'string') primaryOpts.asTrajectory = true; // key fix: treat multi-model as trajectory

      L('NGL loading (try asTrajectory):', name || source);
      try {
        nglComp = await stage.loadFile(source, primaryOpts);
      } catch(err1){
        // Fallback: load without asTrajectory for single-model/odd inputs
        L('asTrajectory load failed, retrying without:', err1.message||err1);
        const fallbackOpts = Object.assign({}, opts||{});
        delete fallbackOpts.asTrajectory;
        nglComp = await stage.loadFile(source, fallbackOpts);
      }

      // Default rep and view
      nglComp.addRepresentation('cartoon', {colorScheme:'chainname'});
      nglComp.autoView();

      // Attach trajectory if present
      const list = nglComp.trajectoryList || [];
      nglTraj = list.length ? list[0] : null;
      const frameSlider = document.getElementById('frame');
      const frameInfo = document.getElementById('frameInfo');

      if (nglTraj) {
        const n = nglTraj.frameCount|0; frameSlider.max = Math.max(0, n-1); frameSlider.value = 0; frameInfo.textContent = `0 / ${n-1}`;
        // Apply initial speed & interpolation
        setNglSpeed();
        setNglInterpolation();
        // Hook manual frame control
        frameSlider.oninput = ()=>{ const f = parseInt(frameSlider.value,10)|0; frameInfo.textContent = `${f} / ${n-1}`; nglTraj.setFrame(f); };
      } else {
        frameSlider.max = 0; frameSlider.value = 0; frameInfo.textContent = '0 / 0';
      }
    }catch(e){ L('NGL load error:', e.message||e); alert('NGL load failed: '+(e.message||e)); }
  }

  function setNglInterpolation(){
    if (!nglTraj) { L('No NGL trajectory for interpolation.'); return; }
    const mode = document.getElementById('interp').value; // 'none'|'linear'|'spline'
    // NGL API supports setFrameInterpolated for smooth stepping; set a mode hint if available
    if (typeof nglTraj.setFrameInterpolation === 'function') {
      nglTraj.setFrameInterpolation(mode);
      L('Interpolation mode:', mode);
    } else {
      L('Interpolation API not available in this NGL build; using discrete frames.');
    }
  }

  function setNglSpeed(){
    if (!nglTraj || !nglTraj.player) return;
    const t = parseInt(document.getElementById('speed').value,10)/100; // 0..1
    const ms = 30 + (1-t)*220; // 250..30 ms per frame
    nglTraj.player.timeout = ms;
    L('Playback speed (ms/frame):', ms);
  }

  document.getElementById('interp').addEventListener('change', setNglInterpolation);
  document.getElementById('speed').addEventListener('input', setNglSpeed);
  document.getElementById('btn-play').addEventListener('click', ()=>{ if (nglTraj && nglTraj.player) nglTraj.player.play(); });
  document.getElementById('btn-pause').addEventListener('click', ()=>{ if (nglTraj && nglTraj.player) nglTraj.player.pause(); });

  let cartoonOn=true; document.getElementById('btn-repr').addEventListener('click', function(){
    if (!nglComp) return; nglComp.removeAllRepresentations();
    if (cartoonOn){ nglComp.addRepresentation('licorice'); this.textContent='Licorice'; }
    else { nglComp.addRepresentation('cartoon',{colorScheme:'chainname'}); this.textContent='Cartoon'; }
    cartoonOn=!cartoonOn;
  });

  // --- MOL* VIEWER (right) for VR ---
  let molstarViewer = null;
  function ensureMolstar(){
    if (molstarViewer) return molstarViewer;
    if (!window.molstar || !molstar.Viewer){ L('Mol* not ready.'); return null; }
    molstarViewer = new molstar.Viewer('molstar', {
      layoutIsExpanded: true,
      layoutShowControls: true,
      layoutShowSequence: true,
      viewportShowAnimation: true,
      pluginStateServer: 'https://webchem.ncbr.muni.cz/molstar-state',
      volumeStreamingServer: 'https://ds.litemol.org'
    });
    molstarViewer.setBackground({variant:'dark'});
    L('Mol* initialized');
    return molstarViewer;
  }

  async function molstarLoadPdbId(id){
    const v = ensureMolstar(); if (!v) return;
    try{ await v.clear(); await v.loadPdbId(id, { }); v.resetCamera(); L('Mol* loaded PDB', id); }
    catch(e){ L('Mol* load PDB error:', e.message||e); }
  }
  async function molstarLoadUrl(url){
    const v = ensureMolstar(); if (!v) return;
    const fmt = (url.split('?')[0].split('#')[0].split('.').pop()||'').toLowerCase();
    const kind = ['cif','mmcif','bcif'].includes(fmt)?'mmcif': (['pdb','ent'].includes(fmt)?'pdb': (fmt==='mmtf'?'mmtf':'mmcif'));
    try{ await v.clear(); await v.loadStructureFromUrl(url, kind, {}); v.resetCamera(); L('Mol* loaded URL', url); }
    catch(e){ L('Mol* load URL error:', e.message||e); alert('Mol* URL load failed (CORS/format?). For VR, host the file in this repo and use its GitHub Pages URL.'); }
  }
  async function molstarLoadFile(file){
    const v = ensureMolstar(); if (!v) return;
    const name = file.name.toLowerCase();
    const kind = name.endsWith('.pdb')||name.endsWith('.ent')?'pdb':(name.endsWith('.mmtf')?'mmtf': 'mmcif');
    const text = await file.text();
    try{ await v.clear(); await v.loadStructureFromData(text, kind, {}); v.resetCamera(); L('Mol* loaded local file', file.name); }
    catch(e){ L('Mol* local load error:', e.message||e); }
  }

  // --- Unified controls (top bar) ---
  const btnOpen = document.getElementById('btn-open');
  const file = document.getElementById('file');
  const url = document.getElementById('url');
  const btnLoadUrl = document.getElementById('btn-load-url');
  const pdb = document.getElementById('pdb');
  const btnLoadPdb = document.getElementById('btn-load-pdb');

  btnOpen.addEventListener('click', ()=> file.click());
  document.querySelector('label[for="file"]').addEventListener('click', ()=> file.click());

  file.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if (!f) return;
    await nglLoad(f, { ext: f.name.split('.').pop() });
    await molstarLoadFile(f); // optional VR for local files; for full VR, prefer hosted URL
    e.target.value='';
  });

  btnLoadUrl.addEventListener('click', async ()=>{
    const u = url.value.trim(); if (!u) return alert('Enter a URL');
    await nglLoad(u, {});
    await molstarLoadUrl(u);
  });

  btnLoadPdb.addEventListener('click', async ()=>{
    const id = (pdb.value||'').trim(); if (!id) return alert('Enter a PDB ID');
    const scheme = 'rcsb://'+id; // NGL built-in fetcher
    await nglLoad(scheme, {});
    await molstarLoadPdbId(id);
  });

  // Initial sanity load (tiny protein)
  (async()=>{ try{ await nglLoad('rcsb://1crn'); setNglSpeed(); }catch(_){} })();
})();
</script>
</body>
</html>
