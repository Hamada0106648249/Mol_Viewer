<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NGL Trajectory — Component.setFrame Diagnostic</title>
<script src="https://unpkg.com/ngl@0.10.4/dist/ngl.js"></script>
<style>
  body{margin:0;background:#0b1021;color:#e8ebff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .bar{display:flex;gap:10px;align-items:center;padding:10px;background:#12172b;border-bottom:1px solid rgba(255,255,255,.12)}
  .bar input,.bar button{background:rgba(255,255,255,.08);color:#e8ebff;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 10px}
  #stage{position:fixed;inset:50px 0 0 0}
  #log{position:fixed;left:10px;top:50px;width:520px;max-height:40vh;overflow:auto;background:rgba(0,0,0,.5);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.15)}
  .row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="bar">
  <button id="open">Open File…</button>
  <input id="file" type="file" accept=".pdb,.cif,.mmcif,.mmtf,.gro,.ent" style="display:none" />
  <div class="row">
    <label>Frame <input id="frame" type="range" min="0" max="0" value="0"></label>
    <span id="fi">0/0</span>
  </div>
  <button id="playComp">Play (component.setFrame)</button>
  <button id="playFallback">Play (fallback: model N)</button>
  <button id="pause">Pause</button>
  <span id="status" style="margin-left:10px;opacity:.85"></span>
</div>
<div id="stage"></div>
<div id="log"></div>

<script>
(function(){
  const log = document.getElementById('log');
  const L = (...a)=>{const s=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); log.innerHTML = '<div>'+s+'</div>'+log.innerHTML; console.log(...a);};

  const stage = new NGL.Stage('stage', { backgroundColor:'#0b1021' });
  window.addEventListener('resize', ()=>stage.handleResize());

  const openBtn = document.getElementById('open');
  const fileInp = document.getElementById('file');
  const frame = document.getElementById('frame');
  const fi = document.getElementById('fi');
  const status = document.getElementById('status');
  const playCompBtn = document.getElementById('playComp');
  const playFallbackBtn = document.getElementById('playFallback');
  const pauseBtn = document.getElementById('pause');

  let comp=null, rep=null, traj=null, nFrames=0, cur=0, playing=false, timer=null;

  const setStatus = t => status.textContent = t;
  const msPerFrame = ()=>80; // ~12.5 FPS; change if needed

  // Robust frame detection with diagnostics
  function detectFrames(){
    let from = 'unknown';
    if (traj && Number.isFinite(traj.frameCount)) { from = 'traj.frameCount'; return { n: (traj.frameCount|0), from }; }
    try { if (comp && comp.maxFrame != null) { from = 'comp.maxFrame+1'; return { n: (comp.maxFrame|0)+1, from }; } } catch(_){}
    try { const f = comp?.structure?.frames; if (Array.isArray(f)) { from = 'structure.frames.length'; return { n: f.length|0, from }; } } catch(_){}
    return { n: 1, from };
  }

  // Camera nudge + representation tweak to prove repaint each frame
  function proveRepaint(i){
    try { stage.viewer.controls.rotate(0.0005*(i%2?1:-1), 0); } catch(_){}
    try { if (rep) rep.setParameters({ radiusScale: (i%2?1.05:1.0) }); } catch(_){}
  }

  function showFrame(i){
    if (!comp) return;
    const d = detectFrames(); nFrames = Math.max(1, d.n);
    cur = ((i%nFrames)+nFrames)%nFrames;
    const model1 = cur + 1;

    let path = '';
    // Preferred path for multi-model PDB without traj: Component.setFrame
    if (comp && typeof comp.setFrame === 'function') {
      try { comp.setFrame(cur); path = 'component.setFrame'; }
      catch(e){ path = 'componentFailed'; }
    }

    // Last-resort selection-per-model
    if (!path || path === 'componentFailed') {
      try {
        if (!rep) rep = comp.addRepresentation('cartoon', { colorScheme:'chainname' });
        rep.setParameters({ sele: `model ${model1}` });
        path = 'fallback: sele "model N"';
      } catch(e){ L('Fallback error:', e.message||e); }
    }

    // Force repaint
    try { comp.updateRepresentations({ what:{ position:true } }); } catch(_){}
    try { stage.viewer.requestRender(); } catch(_){}
    proveRepaint(cur);

    frame.value = cur; fi.textContent = `${cur}/${Math.max(0,nFrames-1)}`;
    setStatus(`Frame ${cur} via ${path} (frames from ${d.from} = ${nFrames})`);
  }

  function stopManual(){ playing=false; if (timer){ clearTimeout(timer); timer=null; } }
  function play(label){
    if (playing || nFrames<=1) { setStatus(nFrames<=1?'No trajectory detected (only 1 frame)':'Already playing'); return; }
    playing = true; setStatus(`Playing (${label})`);
    (function step(){ if (!playing) return; showFrame((cur+1)%nFrames); timer = setTimeout(step, msPerFrame()); })();
  }
  function pauseAll(){ stopManual(); setStatus('Paused'); }

  async function loadSource(src, nameHint){
    try{
      if (comp) stage.removeComponent(comp);
      comp=rep=traj=null; nFrames=cur=0; stopManual();

      const name = nameHint || (src && src.name) || '';
      setStatus('Loading: ' + (name||'file')); L('Loading with asTrajectory:true', name);
      try { comp = await stage.loadFile(src, { asTrajectory:true }); }
      catch(e1){ L('Retry without asTrajectory:', e1.message||e1); comp = await stage.loadFile(src, {}); }

      rep = comp.addRepresentation('cartoon', { colorScheme:'chainname' });
      comp.autoView();

      const list = comp.trajectoryList || [];
      traj = list.length ? list[0] : null;
      L(traj ? `Trajectory detected: frames=${traj.frameCount}` : 'No traj; will use component.setFrame / selection');

      const d = detectFrames();
      nFrames = Math.max(1, d.n);
      L('Frame detection:', { from: d.from, nFrames });

      frame.max = Math.max(0, nFrames-1); frame.value = 0; fi.textContent = `0/${Math.max(0,nFrames-1)}`;
      showFrame(0);
      setStatus(nFrames>1 ? `Ready: ${nFrames} frames (from ${d.from})` : 'Single-frame structure');
    }catch(e){
      L('Load error:', e.message||e); alert('Load failed: '+(e.message||e));
    }
  }

  // UI
  document.getElementById('open').addEventListener('click', ()=>fileInp.click());
  fileInp.addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if (!f){ setStatus('No file selected'); return; }
    L('File selected:', f.name, f.size+' bytes');
    loadSource(f, f.name);
    e.target.value = '';
  });
  frame.addEventListener('input', ()=> showFrame(+frame.value));
  playCompBtn.addEventListener('click', ()=> play('component.setFrame'));
  playFallbackBtn.addEventListener('click', ()=> play('fallback selection'));
  pauseBtn.addEventListener('click', pauseAll);
})();
</script>
</body>
</html>
